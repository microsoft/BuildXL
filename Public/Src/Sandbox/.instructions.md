# Sandbox Component

The Sandbox component implements process execution monitoring across Windows, Linux. It intercepts file system operations to enforce declared dependencies, detect undeclared accesses, and enable correct caching.

## Architecture

### File Access Monitoring
Every process pip runs inside a sandbox that tracks all file reads, writes, probes (existence checks), and directory enumerations. These observations become part of the cache fingerprint. Undeclared accesses cause build errors or prevent caching.

### Platform Implementations

| Platform | Directory | Mechanism |
|----------|-----------|-----------|
| Windows | `Windows/` | **Detours** — hooks system calls at DLL load time via function interposition |
| Linux | `Linux/` | **EBPF** (default). Legacy: **LD_PRELOAD** for dynamic binaries + **ptrace** fallback for static binaries |
| Shared | `Common/` | `FileAccessManifest`, report types, concurrent event queue |

### Linux Dual Mechanism
- **LD_PRELOAD**: Interposes libc functions (open, read, write, stat, mkdir, etc.) via `libDetours.so`
- **ptrace**: For statically linked binaries — traces syscalls via `PTRACE_TRACEME`, reads arguments from registers (`ORIG_RAX`), uses `seccomp` filters. Managed by a daemon process to prevent zombies.

### Filesystem Modes
Controls which view of the filesystem pips see for directory fingerprinting:

| Mode | Writable Mounts | Read-Only Mounts | When Used |
|------|-----------------|------------------|-----------|
| Full Graph | Full build graph | Real filesystem | Without partial evaluation |
| Minimal Pip (default) | Only pip's dependencies | Real filesystem | With `/usePartialEvaluation` |
| Minimal Pip + Alien Files | Outputs + undeclared sources | Real filesystem | With `allowUndeclaredSourceReads` |

Configure with `/filesystemMode` flag.

## Key Types

- `FileAccessManifest` — Declares allowed/denied file access policies per pip (compiled at graph construction)
- `FileAccessPolicy` — Allow/deny rules for specific paths
- `ReportedFileAccess` — A captured file access event at runtime
- `SandboxedProcess` — Core wrapper for sandboxed process execution (in `Engine/Processes/`)
- `AccessChecker` (Linux) — Validates file operations against the manifest

## Sealed Directories

| Type | Contents Known? | Read Policy | Write Policy |
|------|-----------------|-------------|--------------|
| Full Sealed | Yes | Listed files only | No writes |
| Partial Sealed | Yes | Listed files only | Other pips may also write |
| Source Sealed | No (runtime) | All in folder | No writes |
| Exclusive Opaque | No | Producing pip's outputs only | One pip writes |
| Shared Opaque | No | All producing pips' outputs | Multiple pips write |

Sealed directories enable incremental caching — pips rerun only if actually-read files change, not all files in the directory.

## Process Breakaway

Allows specific child processes to escape the sandbox (`unsafe.childProcessesToBreakawayFromSandbox`):
```typescript
Transformer.execute({
    tool: ...,
    unsafe: {
        childProcessesToBreakawayFromSandbox: [a`service.exe`]
    }
});
```

**Use only for trusted services** (telemetry, compiler daemons) that produce no consequential outputs. Breakaway processes are not monitored — undeclared accesses will not be detected.
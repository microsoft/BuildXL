# Pips Component

The Pips component defines BuildXL's core build task abstraction. A **pip** (Primitive Indivisible Process) is an atomic, well-defined computation unit with explicit input/output declarations. This component contains pip data structures, types, and operations.

## Architecture

### Pip Types
- **Process pip**: Launches an executable with arguments, working directory, env vars, and declared I/O
- **Write-file pip**: Writes string content to a file (no process)
- **Copy-file pip**: Copies a file (no process)
- **Service pip**: Long-running background process (breaks normal pip lifecycle)
- **IPC pip**: Communicates with a service pip via inter-process call

## Module Structure

| Directory | Purpose |
|-----------|---------|
| `Dll/` | Pip data structures, types, and operations |
| `UnitTests/` | Pip unit tests |

## Service Pips

Long-running background processes used for daemons (drop upload, symbol publishing) and compiler-as-a-service (Roslyn).

```typescript
const serviceId = Transformer.createService({
    tool: {exe: f`daemon.exe`},
    arguments: [argument("--listen"), argument("localhost:9999")],
    serviceShutdownCmd: {
        tool: {exe: f`daemon.exe`},
        arguments: [argument("--shutdown")]
    }
}).serviceId;

// Consumer pip declares dependency on the service
Transformer.execute({
    tool: {exe: f`client.exe`},
    servicePipDependencies: [serviceId]
});
```

**Key characteristics**:
- Not cached — starts only when dependent pips have cache misses
- Replicated on every worker in distributed builds
- Trusted with all file accesses (inputs not enforced)
- Terminated after all regular pips complete

## Pip Weight

Controls concurrent execution by CPU resource consumption:

```typescript
Transformer.execute({
    weight: 4  // Consumes 4 of /maxproc slots
});
```

- **Static weight**: Explicitly set per pip
- **Dynamic weight** (`/UseHistoricalCpuUsageInfo`): Calculated from historical CPU usage (e.g., pip using 300% CPU counts as 3 slots)
- When both exist, the larger value is used
- Weight < 1 → 1; weight ≥ maxproc → forces solo execution

## Process Timeouts

```typescript
Transformer.execute({
    timeoutInMilliseconds: 600000,         // Hard timeout (10 min)
    warningTimeoutInMilliseconds: 300000   // Warning at 5 min
});
```

**Global flags**:
- `/pipDefaultTimeout:10m` — Default hard timeout
- `/pipDefaultWarningTimeout:5m` — Default warning threshold
- `/pipTimeoutMultiplier:1.5` — Scale all timeouts

On timeout: enumerate process tree → collect heap dumps → kill job object → report failure with dump paths.

## Preserving Outputs

For tools with sophisticated incrementality (gradle, incremental linker):

```typescript
Transformer.execute({
    unsafe: {
        allowPreservedOutputs: 1,    // Trust level (higher = more aggressive)
        incrementalTool: true         // Enable probe-to-read conversion
    }
});
```

**Three-part config**: per-pip flag + global trust level (`/unsafe_PreserveOutputsTrustLevel`) + master switch (`/unsafe_preserveOutputs`).

**Behavior**: Output files not deleted before execution, not stored to cache. Timestamp normalization disabled so tools can detect changes. Preservation mode is part of the pip fingerprint.

## Common Pitfalls
- **Service pip state leakage**: Design services to be stateless or reset state per batch
- **Timeout masking hangs**: High multipliers mask genuine hangs — use selectively
- **Weight deadlock**: If all pips have weight ≥ maxproc, scheduling stalls — reduce weights or increase maxproc
- **Preservation cache misses**: Switching between preserved/non-preserved modes causes cache misses (different fingerprints)
- **Incremental tool under-builds**: Must enable both `allowPreservedOutputs` and `incrementalTool` plus register tool name in config
